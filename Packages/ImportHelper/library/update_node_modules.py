import sublime
from .debug import debug
from .utils import error_message, status_message
from .get_source_folders import get_source_folders
from .exec_command import run_command_async


def update_node_modules(node_modules=[]):
    node_modules.clear()

    source_folders = get_source_folders()

    def callback(err, result):
        get_modules_callback(err, result, node_modules)
        next()

    def next():
        if len(source_folders) > 0:
            source_folder = source_folders.pop(0)
            run_command_async(
                "exportsNodeModules", {"directory": source_folder}, callback
            )

    next()


def get_modules_callback(err, result, node_modules):
    if err:
        return error_message(err)
    if type(result) is not list:
        return error_message("Unexpected type of result: {0}".format(type(result)))
    node_modules.extend(result)
    count = len(result)
    debug("get_modules_callback:result.length", count)
    status_message("+{0} node modules found ({1})".format(count, len(node_modules)))
